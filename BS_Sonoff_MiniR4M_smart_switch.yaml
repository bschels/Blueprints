blueprint:
  name: "Smart Relay Control (Sonoff Mini R4M with SonoffLAN)"
  description: >
    This blueprint is designed for the Sonoff Mini R4M using the SonoffLAN integration.
    
    It supports two modes:
    
    **Detached Mode (Smart Control):**
      - Set the Mini R4M to detached relay mode so it sends a clear action signal ("single", "double", or "long")
        without toggling its relay automatically.
      - Control any smart entity:
          - **Single Tap:**  
            If the entity’s ID starts with "light.", it toggles via light.toggle; otherwise, it uses homeassistant.toggle.
          - **Double Tap:** Optionally trigger a scene.
          - **Long Press:** Adjusts brightness (only for lights) using the specified increment and direction.
    
    **Relay Mode (Direct Relay Control):**
      - The action sensor triggers a direct toggle of the relay.
      - Provide the relay (switch) entity representing the Mini R4M’s relay.
    
    **Setup:**
      - **Action Sensor:** Select the sensor that reports the Mini R4M’s button events.
      - For detached mode, assign your target smart entity.
      - For relay mode, assign the Mini R4M’s relay (switch) entity.
      
  domain: automation

  input:
    action_sensor:
      name: "Action Sensor"
      selector:
        entity:
          domain: sensor

    relay_mode:
      name: "Control Mode"
      default: detached
      selector:
        select:
          options:
            - detached
            - relay

    target_entity:
      name: "Target Entity (Smart Control)"
      selector:
        entity: {}

    target_other:
      name: "Relay Entity (Relay Mode)"
      selector:
        entity:
          domain: switch
      default: ""

    double_tap_scene:
      name: "Double Tap Scene"
      selector:
        entity:
          domain: scene
      default: ""

    dimming_increment:
      name: "Dimming Increment"
      default: 20
      selector:
        number:
          min: 5
          max: 50
          unit_of_measurement: "%"

    dimming_direction:
      name: "Dimming Direction"
      default: up
      selector:
        select:
          options:
            - up
            - down

trigger:
  - platform: state
    entity_id: !input action_sensor

condition: []

action:
  - choose:
      # Detached Mode: Smart Control
      - conditions:
          - condition: template
            value_template: >
              {{ relay_mode == 'detached'
                 and trigger.to_state.state in ['single', 'double', 'long']
                 and target_entity is defined and target_entity | string | length > 0 }}
        sequence:
          - choose:
              # Single Tap: Toggle target entity.
              - conditions:
                  - condition: template
                    value_template: "{{ target_entity.startswith('light.') }}"
                sequence:
                  - service: light.toggle
                    target:
                      entity_id: !input target_entity
              - conditions:
                  - condition: template
                    value_template: "{{ not target_entity.startswith('light.') }}"
                sequence:
                  - service: homeassistant.toggle
                    target:
                      entity_id: !input target_entity

          # Double Tap: Trigger scene if provided.
          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ trigger.to_state.state == 'double' 
                         and double_tap_scene is defined 
                         and double_tap_scene | string | length > 0 }}
                sequence:
                  - service: scene.turn_on
                    target:
                      entity_id: !input double_tap_scene

          # Long Press: Adjust brightness (only if target is a light).
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ trigger.to_state.state == 'long' and target_entity.startswith('light.') }}"
                sequence:
                  - variables:
                      current_brightness: "{{ state_attr(target_entity, 'brightness') | int | default(0) }}"
                      new_brightness: >
                        {% if dimming_direction == 'up' %}
                          {{ [current_brightness + dimming_increment, 255] | min }}
                        {% else %}
                          {{ [current_brightness - dimming_increment, 0] | max }}
                        {% endif %}
                  - service: light.turn_on
                    target:
                      entity_id: !input target_entity
                    data:
                      brightness: "{{ new_brightness }}"

      # Relay Mode: Direct Relay Control
      - conditions:
          - condition: template
            value_template: >
              {{ relay_mode == 'relay'
                 and trigger.to_state.state in ['single', 'double']
                 and target_other is defined and target_other | string | length > 0 }}
        sequence:
          - service: switch.toggle
            target:
              entity_id: !input target_other

mode: restart
